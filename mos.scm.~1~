(define (n-channel-mosfet-model K VT
			#!optional given-name state)
  (3-terminal-device '(mosfet g d s) given-name
    (lambda (vGS iG vDS iD)
      (let-cells (type  ;+ for N channel, - for P channel
                  vov vovsq K/2 iDsat t1 t2 
                  not-cutoff not-ohmic not-not-ohmic
                  cutoff saturated ohmic
                  (zero 0) (two 2))

        (sign VT type)
        (same iG zeroI)
        (sum vov VT vGS)
        (<? VT vov not-cutoff)
        (<? vov vDS not-ohmic)

        (inverter not-cutoff cutoff)
        (controlled-same zero iD cutoff)

        (inverter not-ohmic not-not-ohmic)
        (conjunction not-cutoff not-not-ohmic ohmic)

        (product vDS/2 two vDS)
        (sum t2 vDS/2 vov)
        (product t2 vDS t1)
        (product K t1 iDohmic)
        (controlled-same iDohmic iD ohmic)

        (conjunction not-cutoff not-ohmic saturated)
        (c:quadratic vov vovsq)
        (product K/2 two K)
        (product vovsq K/2 iDsat)
        (controlled-same iDsat iD saturated)

        ;; At most one can be true
        (choose-exactly-one ohmic cutoff saturated)
	
	(if (default-object? state)
	    (begin (binary-amb cutoff)
                   (binary-amb saturated))
	    (case state
	      ((ohmic) ((constant #t) ohmic)
                       ((constant #f) cutoff)
                       ((constant #f) saturated))
	      ((saturated) ((constant #f) active)
			   ((constant #f) cutoff)
			   ((constant #t) saturated))
	      ((cutoff) ((constant #f) ohmic)
			((constant #t) cutoff)
			((constant #f) saturated))
	      (else (error "Bad BJT state" state)))))
      trivial-insides)
    VBEthreshold VCEsaturation))
